<html>

<head>
    <title>Layout Bridge Control</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.min.css"
        integrity="sha512-SbiR/eusphKoMVVXysTKG/7VseWii+Y3FdHrt0EpKgpToZeemhqHeZeLWLhJutz/2ut2Vw1uQEj2MbRF+TVBUA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css"
        integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        .sidebar {
            height: 100vh
        }
    </style>
</head>

<body>
    <main class="d-flex flex-nowrap">
        <div class="sidebar d-flex flex-column flex-shrink-0 p-3 text-bg-dark" style="min-width: 100px;">
            <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none">
                <i class="fas fa-bridge-water bi pe-none me-3"></i>
                <span class="fs-4">LBC Web</span>
            </a>
            <hr />
            <ul class="nav nav-pills flex-column mb-auto" id="sidebar-links">
                <li class="nav-item">
                    <a href="#" id="engine-link" data-link="engines" class="nav-link active" aria-current="page">
                        <i class="fas fa-train bi pe-none me-3"></i>
                        Engines
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" id="serial-link" data-link="serial" class="nav-link text-white" aria-current="page">
                        <i class="fas fa-laptop-code bi pe-none me-3"></i>
                        Serial
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" id="controller-link" data-link="controller" class="nav-link text-white"
                        aria-current="page">
                        <i class="fas fa-gamepad bi pe-none me-3"></i>
                        Controllers
                    </a>
                </li>
            </ul>
        </div>

        <div class="d-flex w-100" id="pages">
            <div class="container mt-2 w-100 mw-100" data-id="engines">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title">Engine List</h4>
                                <button class="btn btn-primary" id="sync-engines"><i class="fas fa-sync"></i></button>
                                <button class="btn btn-primary" id="btn-add-engine"><i class="fas fa-plus"></i></button>
                                <span class="lead">|</span>
                                <button class="btn btn-primary eng-data-btn" disabled><i
                                        class="fas fa-edit"></i></button>
                                <button class="btn btn-primary eng-data-btn" id="btn-engine-control" disabled><i
                                        class="fas fa-gamepad"></i></button>
                                <button class="btn btn-primary eng-data-btn" disabled><i
                                        class="fas fa-minus"></i></button>
                                <button class="mx-2 btn btn-sm btn-primary d-none" id="selected-engine"
                                    disabled></button>
                                <table class="table table-responsive">
                                    <thead class="text-center">
                                        <tr>
                                            <th>Engine UUID</th>
                                            <th style="width: 15vh;">Engine ID</th>
                                            <th style="width: 15vh;">COM</th>
                                            <th>Engine Info</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-center" id="engine-rows">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container mt-2 w-100 mw-100 d-none" data-id="serial">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title">Serial List</h4>
                                <button class="btn btn-primary" id="sync-serial"><i class="fas fa-sync"></i></button>
                                <button class="btn btn-primary ser-data-btn" id="serial-toggle" disabled><i
                                        class="fas fa-wifi"></i></button>

                                <table class="table table-responsive">
                                    <thead class="text-center">
                                        <tr>
                                            <th>Name</th>
                                            <th>SerialNumber</th>
                                            <th>COM Port</th>
                                            <th>Control Type</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-center" id="serial-rows">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container mt-2 w-100 mw-100 d-none" data-id="controller">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title">Controller List</h4>
                                <button class="btn btn-primary" id="sync-serial"><i class="fas fa-sync"></i></button>
                                <button class="btn btn-primary con-data-btn" id="controller-toggle" disabled><i
                                        class="fas fa-wifi"></i></button>

                                <table class="table table-responsive">
                                    <thead class="text-center">
                                        <tr>
                                            <th>Manufacturer</th>
                                            <th>Product</th>
                                            <th>path</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-center" id="controller-rows">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" tabindex="-1" id="add-engine">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Engine</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <div class="mb-3">
                                <label for="controlType" class="form-label">Control Type</label>
                                <select class="form-select" id="controlType">
                                    <option selected>Select one</option>
                                    <option value="TMCC">TMCC</option>
                                    <option value="LEGACY">LEGACY</option>
                                    <option value="MTH">MTH</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="brand" class="form-label">Brand</label>
                            <input type="text" class="form-control" id="brand" placeholder="Lionel, MTH, K-Line, etc">
                        </div>
                        <div class="mb-3">
                            <label for="engineId" class="form-label">Engine ID</label>
                            <input type="number" class="form-control" id="engineId" placeholder="1">
                        </div>
                        <div class="mb-3">
                            <div class="mb-3">
                                <label for="serial" class="form-label">Serial Port</label>
                                <select class="form-select" id="add-engine-serial">
                                    <option value="0" selected>Select one</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" id="btn-add-engine-submit" class="btn btn-primary">Add</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" tabindex="-1" id="toggle-serial">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Toggle Serial Connection</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <div class="mb-3" id="control-type-section">
                                <label for="toggle-serial-controlType" class="form-label">Control Type</label>
                                <select class="form-select" id="toggle-serial-controlType">
                                    <option selected>Select one</option>
                                    <option value="TMCC">TMCC</option>
                                    <option value="LEGACY">LEGACY</option>
                                    <option value="MTH">MTH</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="toggle-serial-serialnumber" class="form-label">Serial Number</label>
                            <input type="string" class="form-control" id="toggle-serial-serialnumber" disabled>
                        </div>
                        <div class="mb-3">
                            <label for="engineId" class="form-label">Serial Path</label>
                            <input type="string" class="form-control" id="toggle-serial-path" disabled>
                        </div>
                        <div class="mb-3">
                            <label for="engineId" class="form-label">Serial Active</label>
                            <input type="string" class="form-control" id="toggle-serial-active" disabled>
                        </div>
                        <span id="toggle-serial-serialnumber"></span>
                        <span id="toggle-serial-path"></span>
                        <span id="toggle-serial-active"></span>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" id="btn-toggle-serial" class="btn btn-primary">Toggle</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" tabindex="-1" id="engine-control">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Engine Control</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-2">
                            Engine Id: <span id="engine-control-id"></span>
                            Path: <span id="engine-control-com"></span>
                        </div>
                        <hr class="lead" />
                        <div class="mb-3">
                            <button class="btn btn-success" id="engine-control-power-on"><i
                                    class="fas fa-power-off"></i> (Quick)</button>
                            <button class="btn btn-success" id="engine-control-power-on-ext"><i
                                    class="fas fa-power-off"></i> (Ext)</button>
                            <button class="btn btn-danger" id="engine-control-power-off"><i
                                    class="fas fa-power-off"></i> (Quick)</button>
                            <button class="btn btn-danger" id="engine-control-power-off-ext"><i
                                    class="fas fa-power-off"></i> (Ext)</button>
                        </div>
                        <hr class="lead" />
                        <div class="mb-3">
                            <div class="mb-1">Direction Control</div>
                            <button class="btn btn-primary" id="engine-control-forward"><i
                                    class="fas fa-backward"></i></button>
                            <button class="btn btn-primary" id="engine-control-toggle"><i
                                    class="fas fa-rotate-right"></i></button>
                            <button class="btn btn-primary" id="engine-control-backward"><i
                                    class="fas fa-forward"></i></button>
                        </div>
                        <div class="mb-3">
                            <label for="engine-control-speed-select" class="form-label">Speed Control</label>
                            <select class="form-select" id="engine-control-speed-select">
                                <option value="abs" selected>Absolute</option>
                                <option value="rel">Relative</option>
                            </select>
                        </div>
                        <div class="mb-3 d-none" id="engine-control-abs-speed">
                            <button class="btn btn-success" id="engine-control-rel-plus-1"><i
                                    class="fas fa-1"></i></button>
                            <button class="btn btn-danger" id="engine-control-rel-minus-1"><i
                                    class="fas fa-1"></i></button>
                        </div>
                        <div class="mb-3 d-none" id="engine-control-rel-speed">
                            <button class="btn btn-success" id="engine-control-rel-plus-1"><i
                                    class="fas fa-1"></i></button>
                            <button class="btn btn-danger" id="engine-control-rel-minus-1"><i
                                    class="fas fa-1"></i></button>
                        </div>
                        <hr class="lead" />
                        <div class="mb-3 d-none" id="engine-control-whistle-slider-view">
                            <label for="engine-control-whistle-slider" class="form-label">Whistle (0/<span
                                    id="engine-control-whistle-max">0)</span></label>
                            <input type="range" class="form-range" min="0" max="0" id="engine-control-whistle-slider"
                                value="0" id="engine-control-whistle">
                        </div>
                        <div class="mb-3 d-none" id="engine-control-whistle-tmcc-view">
                            <button class="btn btn-primary" id="engine-control-whistle-tmcc-on"><i
                                    class="fas fa-wind"></i></button>
                            <button class="btn btn-danger" id="engine-control-whistle-tmcc-off"><i
                                    class="fas fa-wind"></i></button>
                        </div>
                        <div class="mb-3">
                            <button class="btn btn-primary" id="engine-control-bell-on"><i
                                    class="fas fa-bell"></i></button>
                            <button class="btn btn-danger" id="engine-control-bell-off"><i
                                    class="fas fa-bell-slash"></i></button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" id="btn-toggle-serial" class="btn btn-primary">Toggle</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.min.js"
    integrity="sha512-1/RvZTcCDEUjY/CypiMz+iqqtaoQfAITmNSJY17Myp4Ms5mdxPS5UV7iOfdZoxcGhzFbOm6sntTKJppjvuhg4g=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"
    integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.3/axios.min.js"
    integrity="sha512-wS6VWtjvRcylhyoArkahZUkzZFeKB7ch/MHukprGSh1XIidNvHG1rxPhyFnL73M0FC1YXPIXLRDAoOyRJNni/g=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.0/socket.io.min.js"
    integrity="sha512-uXal8CICQ52UxoF9A3yBP6GUXGu5N2IoTZf/YXGMW4M0AvNyViA0ZjpGf9uqRpkN4kyx41Y5I0DmTQNOS6G05A=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>

    const APP_PATH = 'http://localhost:3000'

    let selectedEngine = null
    let selectedSerial = null

    let activePorts = []
    let activeEngines = []
    const engines = []

    const axiosGet = async (path) => {
        return await axios.get(`${APP_PATH}${path}`)
    }

    const axiosPost = async (path, data) => {
        return await axios.post(`${APP_PATH}${path}`, data)
    }

    const showPage = (id) => {
        $('#sidebar-links li a').each(function () {
            const link = $(this)
            if (link.data('link') === id) {
                link.toggleClass('active', true)
                link.toggleClass('text-white', false)
            } else {
                link.toggleClass('active', false)
                link.toggleClass('text-white', true)
            }
        })

        $('#pages .container').each(function () {
            const page = $(this)
            if (page.data('id') === id) {
                page.toggleClass('d-none', false)
            } else {
                page.toggleClass('d-none', true)
            }
        })
    }

    const showEngines = () => {
        showPage("engines")
    }

    const showSerial = () => {
        showPage("serial")
    }

    const showControllers = () => {
        showPage("controller")
    }

    const setEngineButtonsActive = (active) => {
        $('.eng-data-btn').attr('disabled', !active)
    }

    const setSerialButtonsActive = (active) => {
        $('.ser-data-btn').attr('disabled', !active)
    }

    const addTableHoverClass = (elm) => {
        if (elm == null) return
        if (elm.data('id') == null) return
        elm.addClass('bg-secondary').addClass('text-white')
    }

    const removeTableHoverClass = (elm) => {
        if (elm == null) return
        if (elm.data('active') === true) return
        elm.removeClass('bg-secondary').removeClass('text-white')
    }

    const setActiveClass = (elm, setup = false) => {
        $('#engine-rows tr').each(function () {
            const row = elm ?? $(this)
            console.log(row.data('id'), row.data('active'))
            if (row.data('active') == true && setup) {
                addTableHoverClass(row)
            } else if (elm) {
                addTableHoverClass(row)
            } else {
                removeTableHoverClass(row)
            }
        })
    }

    const addSerialPort = (port, active = false) => {
        $('#serial-rows').append(`<tr data-id="${port.serialNumber}" data-open="${active}" data-path="${port.path}" data-controlType="${port.controlType}"><td>${port.name}</td><td>${port.serialNumber}</td><td>${port.path}</td><td>${port.controlType ?? '-'}</td><td><i class="fas fa-circle ${active ? 'text-success' : 'text-danger'}"></i></td></tr>`)
    }

    const addEngine = (engine, active = false) => {
        engines.push({ ...engine, active })
        $('#engine-rows').append(`<tr data-id="${engine.id}"><td>${engine.id}</td><td>${engine.controlId}</td><td>${engine.path}</td><td>${JSON.stringify({ brand: engine.brand, controlType: engine.controlType, speed: engine.currentSpeed, maxSpeed: engine.maxSpeed })}</td></tr>`)
    }

    const addController = (controller) => {
        console.log(controller)
        $('#controller-rows').append(`<tr data-id="${controller.path}"><td>${controller.manufacturer}</td><td>${controller.product}</td><td>${controller.path}</td></tr>`)

    }

    const showWhistleView = (view) => {
        if (view === "LEGACY") {
            $('#engine-control-whistle-slider-view').toggleClass('d-none', false)
            $('#engine-control-whistle-slider').attr('max', 15)
            $('#engine-control-whistle-tmcc-view').toggleClass('d-none', true)
        } else {
            $('#engine-control-whistle-slider-view').toggleClass('d-none', true)
            $('#engine-control-whistle-tmcc-view').toggleClass('d-none', false)
        }
    }

    const getEngineList = async () => {
        const enginesRes = await axiosGet('/engine')
        const activeEngineRes = await axiosGet('/engine/active')

        $('#engine-rows').empty()

        if (enginesRes.data == null || typeof enginesRes.data !== 'object') {
            throw new Error("Invalid engine types")
        }

        activeEngines = []
        if (activeEngineRes.data != null && activeEngineRes.data.length > 0) {
            for (const activeEngine of activeEngineRes.data) {
                activeEngines.push(activeEngine)
            }
        }

        if (enginesRes.data.length === 0) {
            return
        }

        for (let engine of enginesRes.data) {
            const match = activeEngines.find((activeEngine) => activeEngine.id === engine.id)
            if (match != null) {
                engine.active = true
                addEngine(engine, true)
            } else {
                addEngine(engine)
            }
        }
    }

    const getSerialList = async () => {
        const serialRes = await axiosGet('/serial/available')
        const serialActiveRes = await axiosGet('/serial/active')

        $('#serial-rows').empty()

        if (serialRes.data == null || typeof serialRes.data !== 'object') {
            throw new Error("Invalid engine types")
        }

        //console.log('availablePorts', serialRes, 'activePorts', serialActiveRes)

        activePorts = []
        if (serialActiveRes.data != null && serialActiveRes.data.length > 0) {
            for (const activeSerial of serialActiveRes.data) {
                activePorts.push(activeSerial)
            }
        }

        if (serialRes.data.length === 0) {
            return
        }

        for (let serialPort of serialRes.data) {
            const match = activePorts.find((serial) => serial.serialNumber === serialPort.serialNumber)
            if (match != null) {
                serialPort.controlType = match.type
                addSerialPort(serialPort, true)
            } else {
                addSerialPort(serialPort)
            }
        }
    }

    const getControllerList = async () => {
        $('#controller-rows').empty()
        const controllerRes = await axiosGet('/controller')
        if (controllerRes.status === 204) return
        if (controllerRes.data == null || typeof controllerRes.data !== 'object') {
            throw new Error("Invalid controller type")
        }

        if (controllerRes.data.length === 0) {
            return
        }

        for (let controller of controllerRes.data) {
            addController(controller)
        }

        if (controllerRes.data.length > 0) {
            $('#controller-toggle').prop('disabled', false)
        } else {
            $('#controller-toggle').prop('disabled', true)
        }
    }

    const sleep = async (ms) => {
        return new Promise(r => setTimeout(r, ms))
    }

    $(function () {
        $('body').on('mouseenter', 'tr', function () {
            return addTableHoverClass($(this))
        })
        $('body').on('mouseleave', 'tr', function () {
            return removeTableHoverClass($(this))
        })

        $('body').on('click', '#engine-rows tr', async function () {
            const engineId = $(this).data('id')
            await axiosPost('/engine/control', { type: 'engine', engineId })
            selectedEngine = engineId
            $('#selected-engine').html(`Selected engine: ${engineId}`).toggleClass('d-none', false)
            setEngineButtonsActive(true)
        })

        // TODO unselect options if click-away
        // $('body').on('click', function (e) {
        //     const closest = $(e.target).closest('tr').length
        //     console.log(closest)
        //     if ($(this).data('id') != null) return
        //     setEngineButtonsActive(false)
        //     setSerialButtonsActive(false)
        //     selectedEngine = null
        //     selectedSerial = null
        // })

        $('body').on('click', '#serial-rows tr', function () {
            if ($(this).data('id') == null) return
            selectedSerial = {
                serialNumber: $(this).data('id'),
                path: $(this).data('path'),
                active: $(this).data('open'),
                controlType: $(this).data('controlType')
            }
            setSerialButtonsActive(true)
        })

        $('#serial-toggle').on('click', async function () {
            if (selectedSerial == null) return
            if (selectedSerial.active) {
                $('#control-type-section').addClass('d-none')
            } else {
                if (selectedSerial.controlType) {
                    ('#toggle-serial-controlType').val(selectedSerial.controlType)
                }
                $('#control-type-section').removeClass('d-none')
            }
            $('#toggle-serial-serialnumber').val(selectedSerial.serialNumber)
            $('#toggle-serial-path').val(selectedSerial.path)
            $('#toggle-serial-active').val(selectedSerial.active ? 'Active' : 'Inactive')
            $('#toggle-serial').modal('show');
        })

        $('#engine-link').click(function () {
            showEngines()
        })

        $('#serial-link').click(function () {
            showSerial()
        })

        $('#controller-link').click(function () {
            showControllers()
        })

        $('#btn-add-engine').click(function () {
            $('#add-engine-serial')
                .empty()
                .append(`<option selected>Select One</option>`)
            if (activePorts != null && typeof activePorts === 'object' && activePorts.length > 0) {
                for (const activePort of activePorts) {
                    $('#add-engine-serial').append(`<option value="${activePort.path}">${activePort.path}</option>`)
                }
            }
            $('#add-engine').modal('show');
        })

        $('#btn-add-engine-submit').click(async function () {
            const controlType = $('#controlType').val()
            const engineId = $('#engineId').val()
            const brand = $('#brand').val()
            const com = $('#add-engine-serial').val()

            if (controlType == null || engineId == null || brand == null || com == null) {
                console.log('reject', controlType, engineId, brand, com)
                return
            }

            await axiosPost('/engine/add', { engineId, controlType, brand, com })
            await getEngineList()
            $('#add-engine').modal('hide')
        })

        $('#btn-toggle-serial').click(async function () {
            if (selectedSerial == null) return
            if (selectedSerial.active == false) {
                console.log(selectedSerial.controlType, $('#toggle-serial-controlType').val(), null)
                const controlType = selectedSerial.controlType ?? $('#toggle-serial-controlType').val() ?? null
                await axiosPost('/serial/toggle', { serialNumber: selectedSerial.serialNumber, controlType })
            } else {
                await axiosPost('/serial/toggle', { serialNumber: selectedSerial.serialNumber })
            }

            // Sleep long enough for COM to open
            await sleep(1000)
            await getSerialList()
            $('#toggle-serial').modal('hide')
        })

        $('#sync-serial').click(async function () {
            getSerialList()
        })

        $('#sync-engines').click(async function () {
            getEngineList()
        })

        $('#controller-toggle').click(async function () {
            await axiosPost('/controller/toggle')
        })

        $('#btn-engine-control').click(async function () {
            if (selectedEngine == null) return
            const engineInfo = engines.find((engine) => engine.id === selectedEngine)
            //console.log(selectedEngine, engineInfo)
            showWhistleView(engineInfo.controlType)
            $('#engine-control-id').html(engineInfo.controlId)
            $('#engine-control-com').html(`${engineInfo.path} (${engineInfo.controlType})`)
            $('#engine-control').modal('show')
        })

        $('#engine-control-whistle-slider').on('input', async function () {
            //console.log($('#engine-control-whistle-slider').val())
            await axiosPost('/engine/control', { type: 'whistle', whistle: $('#engine-control-whistle-slider').val() })
        })

        $('#engine-control-whistle-slider').on('change', async function () {
            await sleep(25)
            $('#engine-control-whistle-slider').val("0")
            await axiosPost('/engine/control', { type: 'whistle', whistle: 0 })
        })

        $('#engine-control-bell-on').click(async function () {
            if (selectedEngine == null) return
            await axiosPost('/engine/control', { type: 'bellOn' })
        })

        $('#engine-control-bell-off').click(async function () {
            if (selectedEngine == null) return
            await axiosPost('/engine/control', { type: 'bellOff' })
        })

        $('#engine-control-power-on').click(async function () {
            if (selectedEngine == null) return
            await axiosPost('/engine/control', { type: 'startUpFast' })
        })

        $('#engine-control-power-off').click(async function () {
            if (selectedEngine == null) return
            await axiosPost('/engine/control', { type: 'shutDownFast' })
        })

        $('#engine-control-rel-plus-1').click(async function () {
            if (selectedEngine == null) return
            await axiosPost('/engine/control', { type: 'incrementSpeed' })
        })

        $('#engine-control-rel-minus-1').click(async function () {
            if (selectedEngine == null) return
            await axiosPost('/engine/control', { type: 'decrementSpeed' })
        })



        const load = async () => {
            const promise = Promise.all([
                getEngineList(),
                getSerialList(),
                getControllerList()
            ])
            await promise
        }

        load().then(() => {
            setActiveClass(null, true)
        }).catch((err) => {
            console.log(err)
        })
    })
</script>

</html>